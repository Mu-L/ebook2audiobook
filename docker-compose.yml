version: "3.9"

x-gpu-enabled: &gpu-enabled
  devices:
    - driver: nvidia
      count: all
      capabilities: [gpu]

x-gpu-disabled: &gpu-disabled
  devices: []

services:
  ebook2audiobook:
    # The build args TORCH_WHEEL, TORCHAUDIO_WHEEL, DEVICE
    # come from the `.env` generated by docker_build.sh
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TORCH_WHEEL: ${TORCH_WHEEL}
        TORCHAUDIO_WHEEL: ${TORCHAUDIO_WHEEL}
        DEVICE: ${DEVICE}

    image: ebook2audiobook:${DEVICE}

    tty: true
    stdin_open: true

    ports:
      - "7860:7860"

    deploy:
      resources:
        reservations:
          <<: *gpu-disabled   # builder enables GPU only when needed
        limits: {}

    volumes:
      - ./:/app    # map project directory inside the container

    # ENTRYPOINT comes from Dockerfile, so no command needed
    command: []   # (you can pass extra args here if needed)