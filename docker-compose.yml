services:
  ebook2audiobook:
    image: athomasson2/ebook2audiobook:${DEVICE_TAG:-cu128}  # or just ebook2audiobook:${DEVICE_TAG:-cu128} if you run your own local docker
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_VERSION: ${APP_VERSION:-26.1.16}
        DEVICE_TAG: ${DEVICE_TAG:-cu128}
    working_dir: /app
    entrypoint: ["python", "app.py", "--script_mode", "full_docker"]
    tty: true
    stdin_open: true
    ports:
      - "7860:7860"
    privileged: true   # Kept as required for some Unraid users

    # Default profile = CPU (safe everywhere)
    profiles:
      - cpu

    volumes:
      - .:/app:rw      # Bind mount current directory – works everywhere

    restart: unless-stopped

    # Legacy NVIDIA runtime fallback – harmless on non-NVIDIA hosts
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility


  ebook2audiobook-gpu:
    extends:
      service: ebook2audiobook

    # Explicit GPU profile only
    profiles:
      - gpu

    # NVIDIA GPU passthrough – only enabled when profile=gpu
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]